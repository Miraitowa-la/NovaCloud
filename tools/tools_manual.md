# NovaCloud 项目工具箱说明文档

本文档旨在详细介绍 `NovaCloud` 项目 `tools` 目录下的各种实用脚本和工具。这些工具旨在帮助开发和管理 NovaCloud 平台。

## 目录

1.  [数据库清理工具 (`clear_database.py`)](#1-数据库清理工具-clear_databasepy)
    *   [1.1 功能概述](#11-功能概述)
    *   [1.3 使用方法](#13-使用方法)
    *   [1.2 重要警告](#12-重要警告)
    *   [1.4 数据清理顺序](#14-数据清理顺序)
    *   [1.6 设置模块自动检测](#16-设置模块自动检测)
    *   [1.5 注意事项](#15-注意事项)
    *   [1.7 常见问题解决](#17-常见问题解决)
    *   [1.8 TCP服务器自动启动问题](#18-tcp服务器自动启动问题)
2.  未来工具...

---

## 1. 数据库清理工具 (`clear_database.py`)

`clear_database.py` 是一个 Python 脚本，用于清空 NovaCloud 项目的 SQLite 数据库 (`db.sqlite3`) 中的大部分数据。它特别适用于开发和测试阶段，当你需要一个干净的数据库环境时。

### 1.1 功能概述

*   **环境设置**：脚本会自动设置 Django 运行环境，以便正确加载和使用 Django ORM。
*   **智能项目设置检测**：使用多种策略自动分析项目结构，检测正确的 Django 设置模块路径。
*   **Python路径管理**：自动将项目目录添加到Python路径，确保能找到项目模块。
*   **模型导入**：导入所有相关的 Django 模型，包括用户账户、物联网设备、策略引擎和核心审计日志等。
*   **数据清空**：按照预定义的、安全的顺序删除指定模型中的所有数据记录。
*   **外键处理**：删除顺序经过精心设计，以避免因外键约束导致的操作失败。利用了 Django ORM 的级联删除特性。
*   **用户确认**：在执行任何删除操作之前，脚本会要求用户明确输入确认信息，以防止意外清空数据。
*   **日志输出**：脚本在执行过程中会打印详细的日志信息，告知用户每个模型的数据清理情况。
*   **错误处理**：包含全面的错误处理，提供清晰的错误信息和解决方案建议。

### 1.3 使用方法

1.  **定位脚本**：确保 `clear_database.py` 脚本位于你的 NovaCloud 项目的 `tools` 目录下。
2.  **打开终端**：在你的 NovaCloud 项目的**根目录**下（即与 `manage.py` 文件同级的目录）打开命令行终端。
3.  **执行脚本**：运行以下命令：
    ```bash
    python tools/clear_database.py
    ```
4.  **项目设置检测**：脚本会自动检测项目的设置模块路径。如果首次尝试失败，脚本会使用多种备选策略。如果所有自动检测都失败，会提示你手动输入。
5.  **确认操作**：脚本会显示如下警告信息，并提示你输入确认：
    ```
    ================================================================================
    警告: 此操作将清空数据库中的所有数据！
    此操作不可撤销，请确保你已备份重要数据。
    ================================================================================

    请输入 'yes' 确认继续操作，或任意其他键取消:
    ```
    输入 `yes` 并按回车键以继续。如果输入其他任何内容或直接按回车，操作将被取消。
6.  **查看输出**：脚本会开始清空数据，并打印每个步骤的执行结果。

### 1.2 重要警告

*   **数据不可恢复**：一旦执行此脚本并确认操作，数据库中的相关数据将被永久删除，且无法恢复。
*   **备份数据**：在运行此脚本之前，强烈建议备份你的 `db.sqlite3` 文件，尤其是当数据库中包含任何重要数据时。
*   **生产环境禁用**：此脚本主要为开发和测试环境设计，**严禁在生产环境中使用**，除非你完全清楚其后果并已做好充分准备。

### 1.4 数据清理顺序

脚本按照以下顺序和逻辑清空数据，以确保数据完整性和避免外键约束问题：

1.  **策略引擎相关数据** (依赖较少，通常是叶子节点)：
    *   `ExecutionLog`
    *   `Action`
    *   `Condition`
    *   `ConditionGroup`
    *   `Strategy`
2.  **物联网数据存储和日志**：
    *   `SensorData`
    *   `ActuatorCommandLog`
3.  **物联网核心实体**：
    *   `Project`：删除 `Project` 会通过 Django ORM 的 `on_delete=models.CASCADE` 设置，级联删除所有关联的 `Device`。同样，删除 `Device` 会级联删除其关联的 `Sensor` 和 `Actuator`。因此，只需删除 `Project` 即可清理所有这些相关的核心实体。
4.  **账户和系统辅助数据**：
    *   `InvitationCode`
    *   `AuditLog`
5.  **用户和角色核心数据**：
    *   `User`：删除 `User` 对象会通过 `UserProfile` 模型中 `OneToOneField` 的 `on_delete=models.CASCADE` 设置，级联删除所有关联的 `UserProfile`。
        *   默认情况下，脚本会删除**所有**用户，包括超级用户。
    *   `Role`：在 `User` 和 `UserProfile` 被删除后，可以安全地删除 `Role`。

### 1.6 设置模块自动检测

脚本使用以下多重策略来自动检测正确的 Django 设置模块路径：

1.  **从 manage.py 文件分析**：
    *   读取项目的 `manage.py` 文件内容，使用正则表达式搜索 `DJANGO_SETTINGS_MODULE` 的设置。
    *   如果找到设置，会尝试导入以验证其可用性。

2.  **尝试常见的默认设置路径**：
    *   如果从 manage.py 未找到可用的设置模块，会尝试几个常见的设置模块路径，如：
        * `项目名.settings`（例如 `NovaCloud.settings`）
        * `config.settings`（常见于使用特定项目结构的Django项目）
        * `app.settings`
        * `settings`（直接位于根目录的settings模块）
        * `src.settings`
    *   如果前面从 manage.py 检测到了设置但导入失败，还会尝试相关变体。

3.  **文件系统扫描**：
    *   如果前两种方法都失败，脚本会扫描项目目录查找所有 `settings.py` 文件。
    *   找到的设置文件会展示给用户，如果只有一个选项，会自动尝试使用；如果有多个选项，会让用户选择。

4.  **手动输入**：
    *   如果所有自动检测方法都失败，脚本会提示用户手动输入正确的设置模块路径。
    *   脚本会尝试导入用户输入的模块，如果失败会提供反馈并允许再次尝试，直到成功导入或用户取消操作。

所有这些机制旨在使脚本能够在各种不同的Django项目结构中正确地找到设置模块，无需用户手动修改脚本。

### 1.5 注意事项

*   **项目根目录执行**：脚本包含检查机制，如果不是在包含 `manage.py` 的项目根目录下运行，将会报错并退出。
*   **Django 设置模块**：脚本现在会自动检测 Django 项目的设置模块路径，你通常不需要手动修改脚本。
*   **超级用户保留**：如果你希望在清理数据时保留超级用户账户，你需要修改脚本中删除 `User` 对象的代码行。
    *   找到以下代码行：
        ```python
        deleted_count = User.objects.all().delete()
        ```
    *   将其修改为：
        ```python
        deleted_count = User.objects.filter(is_superuser=False).delete()
        print(f"已清除所有非超级用户及其关联的 UserProfile 数据: {deleted_count}")
        # 如果还需要单独处理超级用户的 Profile（虽然通常不需要，因为上面只删除了非超级用户）
        # superuser_profiles = UserProfile.objects.filter(user__is_superuser=True)
        # print(f"保留 {superuser_profiles.count()} 个超级用户的 Profile。")
        ```
*   **依赖关系**：脚本的成功运行依赖于 Django 项目的正确配置和相关应用的模型定义。

### 1.7 常见问题解决

*   **找不到设置模块错误** (`ModuleNotFoundError: No module named 'xxx'`)：
    *   自动检测功能已经大大增强，能够处理大多数项目结构。如果仍然遇到问题：
    *   检查 `sys.path` 输出，确认项目目录是否在Python路径中。
    *   手动输入设置模块路径时，确保使用点号分隔，如 `myproject.settings`。
    *   如果项目使用非标准布局，可能需要调整 `PYTHONPATH` 环境变量。

*   **找不到应用或模型错误** (`ImportError: No module named 'app_name'`)：
    *   确保你已经安装了所有必要的依赖项。可以运行 `pip install -r requirements.txt`（如果存在）。
    *   如果你使用虚拟环境，确保已激活正确的虚拟环境 (通常命令为 `source .venv/bin/activate` 或 `.venv\Scripts\activate`)。
    *   检查项目的 `INSTALLED_APPS` 设置，确保包含了所有需要的应用。
    *   如果某个应用存在但导入失败，可能是因为Python路径问题或循环导入。

*   **数据库锁定错误**：
    *   确保没有其他进程（如 Django 开发服务器）正在访问数据库。
    *   检查是否存在未完成的数据库事务。
    *   对于 SQLite：如果使用的是 SQLite 数据库并出现锁定错误，可能需要增加默认的超时设置。
    *   如果问题持续存在，尝试关闭所有可能访问数据库的进程，或者重新启动计算机。

*   **设置导入错误** (`ImproperlyConfigured` 或其他设置相关错误)：
    *   检查 `settings.py` 文件中的环境变量依赖，可能需要设置某些环境变量。
    *   确认项目使用的Django版本与你环境中安装的版本兼容。
    *   查看设置模块是否有依赖于其他Python包的导入，确保这些包已安装。

*   **手动解决极端情况**：
    *   在万不得已的情况下，可以考虑直接使用 SQLite 命令行工具或 GUI 工具（如 DB Browser for SQLite）手动操作数据库。
    *   如果只是需要一个干净的数据库，也可以备份当前数据库，然后删除 `db.sqlite3` 文件，并运行 `python manage.py migrate` 创建一个全新的数据库。

### 1.8 TCP服务器自动启动问题

在运行 `clear_database.py` 脚本时，你可能会注意到控制台输出中显示有 TCP 服务器自动启动的信息，如下所示：

```
[自动启动] TCP服务器线程已启动
[TCP服务器] [自动启动] TCP服务器已在 0.0.0.0:8100 启动 (PID: 24172)
[TCP服务器] 正在启动TCP服务器，监听地址: 0.0.0.0:8100...
```

这是因为:

*   **自动启动机制**: NovaCloud 项目在 Django 设置加载时会自动启动 TCP 服务器。由于我们的脚本需要加载 Django 设置，所以也会触发 TCP 服务器的自动启动。
*   **端口冲突**: 如果多次运行脚本，或者已有其他 TCP 服务器实例在运行，可能会看到端口冲突错误信息。

**处理方法**:

1.  **忽略这些消息**: 这些自动启动消息不会影响数据库清理操作，你可以安全地继续使用脚本。

2.  **手动关闭 TCP 服务器**:
    *   可以在完成数据库清理操作后，使用 `Ctrl+C` 终止整个脚本进程，这也会终止自动启动的 TCP 服务器。
    *   或者，可以打开任务管理器（Windows）或使用 `ps` 命令（Linux/Mac）找到相关 Python 进程并终止它们。

3.  **临时禁用自动启动** (高级用户):
    *   如果你熟悉 NovaCloud 项目结构，可以临时修改相关设置以禁用 TCP 服务器的自动启动功能。
    *   可能的位置:
        * `NovaCloud/settings.py` 文件中查找 TCP 服务器自动启动的相关配置。
        * Django `AppConfig` 的 `ready()` 方法中可能包含启动 TCP 服务器的代码。
        * 可能有专门的 `communication_handler` 应用或模块包含自动启动逻辑。

4.  **使用环境变量控制** (如果项目支持):
    *   NovaCloud 项目可能提供环境变量来控制 TCP 服务器的自动启动行为。
    *   例如，可以尝试在运行脚本前设置如下环境变量（具体变量名需要查看项目代码确认）：
        ```bash
        # Windows
        set NOVACLOUD_DISABLE_TCP_AUTOSTART=1
        python tools/clear_database.py
        
        # Linux/Mac
        NOVACLOUD_DISABLE_TCP_AUTOSTART=1 python tools/clear_database.py
        ```

**注意**: 自动启动的 TCP 服务器不会影响数据库清理操作的功能，所以在大多数情况下，你可以忽略这些消息并正常使用脚本。

---

*（后续可以继续添加其他工具的说明）* 