{% extends 'base.html' %}

{% block title %}设备详情 - {{ device.name }} - NovaCloud{% endblock %}

{% block content %}
<!-- 添加CSRF token以支持AJAX POST请求 -->
{% csrf_token %}

<div class="container">
    <!-- 设备信息卡片 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">设备信息</h4>
            <a href="{% url 'iot_devices:device_update' project.project_id device.device_id %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-edit"></i> 编辑设备信息
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">设备名称</h5>
                        <p class="lead">{{ device.name }}</p>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">设备物理标识</h5>
                        {% if device.device_identifier %}
                            <p>{{ device.device_identifier }}</p>
                        {% else %}
                            <p>{{ "无设备物理标识" }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">状态</h5>
                        <p>
                            {% if device.status == 'online' %}
                                <span class="status-dot status-dot-success"></span> 在线
                            {% elif device.status == 'offline' %}
                                <span class="status-dot status-dot-offline"></span> 离线
                            {% else %}
                                <span class="status-dot status-dot-warning"></span> 未注册
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-muted">创建时间</h5>
                    <p>{{ device.created_at|date:"Y-m-d H:i:s" }}</p>
                </div>

                <div class="col-md-6">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">最后上线时间</h5>
                        {% if device.last_seen %}
                        <p>{{ device.last_seen|date:"Y-m-d H:i:s" }} ({{ device.last_seen|timesince }}前)</p>
                        {% else %}
                        <p>{{ "设备从未上线" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="device-info mb-3">
                        <h5 class="text-muted">设备ID</h5>
                        <div class="device-id-container">
                            <input type="text" class="form-control" value="{{ device.device_id }}" id="device_id" readonly>
                            <button class="btn btn-outline-primary copy-btn" type="button" onclick="copyToClipboard('device_id')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                    </div>

            <div class="device-info mb-3">
                        <h5 class="text-muted">设备密钥 <span class="text-danger">(重要，请妥善保管)</span></h5>
                        <div class="device-id-container">
                            <input type="text" class="form-control" value="{{ device.device_key }}" id="device_key" readonly>
                            <button class="btn btn-outline-primary copy-btn" type="button" onclick="copyToClipboard('device_key')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                        <small class="form-text text-muted">此密钥用于设备连接认证，请妥善保管，避免泄露。</small>
                    </div>
        </div>
    </div>

    <!-- 传感器部分 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">传感器列表</h4>
            <a href="{% url 'iot_devices:sensor_add' project.project_id device.device_id %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus"></i> 添加传感器
            </a>
        </div>
        <div class="card-body">
            {% if sensors %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>单位</th>
                                <th>数据键名</th>
                                <th>最新数据</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sensors_with_latest_data %}
                                <tr>
                                    <td>{{ item.sensor_info.name }}</td>
                                    <td>{{ item.sensor_info.sensor_type }}</td>
                                    <td>{{ item.sensor_info.unit }}</td>
                                    <td><code>{{ item.sensor_info.value_key }}</code></td>
                                    <td>
                                        {% if item.latest_value is not None %}
                                            <strong>{{ item.latest_value }}</strong>
                                            {% if item.sensor_info.unit %} {{ item.sensor_info.unit }}{% endif %}
                                            <span class="text-muted ml-2">({{ item.latest_data_record.timestamp|timesince }}前)</span>
                                        {% else %}
                                            <span class="text-muted">暂无数据</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'iot_devices:sensor_update' project.project_id device.device_id item.sensor_info.id %}" class="btn btn-outline-secondary btn-sm me-1">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'iot_devices:sensor_delete' project.project_id device.device_id item.sensor_info.id %}" class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('您确定要删除传感器 \'{{ item.sensor_info.name }}\' 吗？此操作不可恢复！');">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center">
                    <p class="text-muted mb-3">该设备还没有添加任何传感器</p>
                    <a href="{% url 'iot_devices:sensor_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> 添加第一个传感器
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 执行器部分 -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">执行器列表</h4>
            <a href="{% url 'iot_devices:actuator_add' project.project_id device.device_id %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus"></i> 添加执行器
            </a>
        </div>
        <div class="card-body">
            {% if actuators %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>命令键名</th>
                                <th>当前状态</th>
                                <th style="min-width: 220px;">控制</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for actuator in actuators %}
                                <tr>
                                    <td>{{ actuator.name }}</td>
                                    <td>{{ actuator.actuator_type }}</td>
                                    <td><code>{{ actuator.command_key }}</code></td>
                                    <td>
                                        {% if actuator.current_state_payload %}
                                            <code>{{ actuator.current_state_payload }}</code>
                                        {% else %}
                                            <span class="text-muted">未知</span>
                                        {% endif %}
                                    </td>
                                    <td class="actuator-control-cell">
                                        <!-- 根据执行器类型显示不同的控制界面 -->
                                        {% if actuator.actuator_type == 'switch' %}
                                            <!-- 开关类型控制 -->
                                            <div class="btn-group">
                                                <button class="btn btn-success btn-sm actuator-control-btn me-1" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-value="ON"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-power-off"></i> 开
                                                </button>
                                                <button class="btn btn-danger btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-value="OFF"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-power-off"></i> 关
                                                </button>
                                            </div>
                                        {% elif actuator.actuator_type == 'dimmer' %}
                                            <!-- 调光器类型控制 -->
                                            <div class="input-group input-group-sm actuator-input-group">
                                                <input type="number" class="form-control form-control-sm" 
                                                       id="dimmer-value-{{ actuator.id }}" 
                                                       min="0" max="100" value="50" placeholder="0-100">
                                                <button class="btn btn-primary btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-target-input-id="dimmer-value-{{ actuator.id }}"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-check"></i> 设置
                                                </button>
                                            </div>
                                        {% else %}
                                            <!-- 通用控制 -->
                                            <div class="input-group input-group-sm actuator-input-group">
                                                <input type="text" class="form-control form-control-sm" 
                                                       id="generic-value-{{ actuator.id }}" 
                                                       placeholder="输入命令值">
                                                <button class="btn btn-primary btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-target-input-id="generic-value-{{ actuator.id }}"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-paper-plane"></i> 发送
                                                </button>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'iot_devices:actuator_update' project.project_id device.device_id actuator.id %}" class="btn btn-outline-secondary btn-sm me-1" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'iot_devices:actuator_delete' project.project_id device.device_id actuator.id %}" class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('您确定要删除执行器 \'{{ actuator.name }}\' 吗？此操作不可恢复！');" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center">
                    <p class="text-muted mb-3">该设备还没有添加任何执行器</p>
                    <a href="{% url 'iot_devices:actuator_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> 添加第一个执行器
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* 复制按钮样式，支持明暗主题 */
    .copy-btn {
        color: var(--color-primary);
        border-color: var(--color-primary);
        min-width: 80px;
        margin-left: 10px;
    }
    
    .copy-btn:hover {
        background-color: var(--color-primary);
        color: var(--text-on-primary);
    }
    
    /* 设备ID/密钥容器 */
    .device-id-container {
        display: flex;
        align-items: center;
        width: 100%;
    }
    
    .device-id-container .form-control {
        flex: 1;
    }
    
    /* 复制提示样式 */
    .copy-tooltip {
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    /* 执行器控制相关样式 */
    .input-group-sm .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* 执行器输入组样式 - 确保不换行 */
    .actuator-input-group {
        display: flex;
        flex-wrap: nowrap !important;
        width: 100%;
    }
    
    .actuator-input-group .form-control {
        min-width: 80px;
        max-width: 120px;
        flex-shrink: 1;
    }
    
    .actuator-input-group .btn {
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .actuator-control-cell {
        min-width: 220px;
        width: 220px;
    }
    
    /* 命令反馈提示样式 */
    .command-feedback {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .command-feedback.success {
        background-color: var(--color-success, #28a745);
        color: white;
    }
    
    .command-feedback.error {
        background-color: var(--color-danger, #dc3545);
        color: white;
    }
    
    /* 操作按钮中的图标与文本间隔 */
    .btn i {
        margin-right: 4px;
    }
</style>

{% block extra_body_js %}
<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        document.execCommand("copy");
        
        // 创建提示元素
        const tooltip = document.createElement("div");
        tooltip.className = "copy-tooltip alert alert-success";
        tooltip.textContent = "已复制到剪贴板";
        tooltip.style.position = "fixed";
        tooltip.style.top = "20px";
        tooltip.style.left = "50%";
        tooltip.style.transform = "translateX(-50%)";
        tooltip.style.padding = "8px 16px";
        tooltip.style.zIndex = "9999";
        document.body.appendChild(tooltip);
        
        // 2秒后移除提示
        setTimeout(function() {
            document.body.removeChild(tooltip);
        }, 2000);
    }
    
    // 执行器控制相关脚本
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有执行器控制按钮
        const controlButtons = document.querySelectorAll('.actuator-control-btn');
        
        // 为每个按钮添加点击事件监听器
        controlButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                
                // 禁用按钮，显示加载状态
                this.disabled = true;
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发送中...';
                
                // 获取必要的数据
                const actuatorId = this.getAttribute('data-actuator-id');
                const apiUrl = this.getAttribute('data-api-url');
                const targetInputId = this.getAttribute('data-command-target-input-id');
                
                // 确定命令值
                let commandValue;
                if (targetInputId) {
                    // 从关联的输入框获取值
                    const inputElement = document.getElementById(targetInputId);
                    if (!inputElement || !inputElement.value.trim()) {
                        showFeedback('请输入有效的命令值', 'error');
                        this.disabled = false;
                        this.innerHTML = originalHtml;
                        return;
                    }
                    commandValue = inputElement.value.trim();
                } else {
                    // 直接从按钮属性获取值
                    commandValue = this.getAttribute('data-command-value');
                }
                
                // 准备CSRF Token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 '{{ csrf_token }}';
                
                // 发送AJAX请求
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ value: commandValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showFeedback('命令已发送处理', 'success');
                    } else {
                        showFeedback(data.message || '命令发送失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('发送命令时出错:', error);
                    showFeedback('发送命令时发生错误', 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    this.disabled = false;
                    this.innerHTML = originalHtml;
                });
            });
        });
        
        // 显示反馈提示
        function showFeedback(message, type) {
            const feedback = document.createElement('div');
            feedback.className = `command-feedback ${type}`;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            // 2秒后移除提示
            setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(feedback), 500);
            }, 2000);
        }
    });
</script>
{% endblock %}
{% endblock %} 