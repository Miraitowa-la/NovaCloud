{% extends 'base.html' %}

{% block title %}设备详情 - {{ device.name }} - NovaCloud{% endblock %}

{% load static %}

{% block extra_head_css %}
<!-- 可以在这里添加额外的CSS -->
<style>
    .device-id-container {
        display: flex;
        gap: 10px;
    }
    .device-id-container input {
        flex-grow: 1;
    }
    .copy-btn {
        flex-shrink: 0;
    }
    
    /* 表格内的操作按钮间距 */
    .me-1 {
        margin-right: 0.25rem;
    }
    
    /* 执行器控制按钮组样式 */
    .actuator-control-cell {
        min-width: 180px;
    }
    .actuator-input-group {
        display: flex;
    }
    .actuator-input-group input {
        max-width: 100px;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    .actuator-input-group .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* 图表相关样式 */
    .chart-wrapper {
        position: relative;
        margin: 0 auto;
        height: 300px;
        width: 100%;
        background-color: var(--background-default);
        border-radius: var(--border-radius-md);
        overflow: hidden;
    }

    .sensor-chart-container {
        background-color: var(--background-default);
        border-top: 1px solid var(--border-default);
        padding: 1rem;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    /* 时间范围选择器样式 */
    .sensor-data-range-selector {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    .sensor-data-range-selector .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.775rem;
        margin: 0 0.15rem;
    }

    /* 加载指示器样式 */
    .chart-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(var(--color-primary-rgb), 0.3);
        border-radius: 50%;
        border-top: 3px solid var(--color-primary);
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 无数据提示样式 */
    .no-data-message {
        padding: 2rem;
        text-align: center;
        background-color: var(--background-default);
        border-radius: var(--border-radius-md);
    }

    /* 图表切换按钮样式 */
    .chart-toggle-btn {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-default);
        transition: background-color 0.2s ease;
    }

    .chart-toggle-btn button {
        box-shadow: none;
        transition: all 0.2s ease;
    }

    .chart-toggle-btn:hover {
        background-color: var(--background-hover);
    }
</style>
{% endblock %}

{% block content %}
<!-- 添加CSRF token以支持AJAX POST请求 -->
{% csrf_token %}

<div class="container">
    <!-- 页面头部 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>设备详情：{{ device.name }}</h2>
    </div>
    
    <!-- 设备信息卡片 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">设备信息</h4>
            <a href="{% url 'iot_devices:device_update' project.project_id device.device_id %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit"></i> 编辑设备信息
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">设备名称/设备物理标识</h5>
                        {% if device.device_identifier %}
                            <p>{{ device.name }}/{{ device.device_identifier }}</p>
                        {% else %}
                            <p>{{ device.name }}/{{ "无设备物理标识" }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">状态</h5>
                        <p>
                            {% if device.status == 'online' %}
                                <span class="status-dot status-dot-success"></span> 在线
                            {% elif device.status == 'offline' %}
                                <span class="status-dot status-dot-offline"></span> 离线
                            {% else %}
                                <span class="status-dot status-dot-warning"></span> 未注册
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-muted">创建时间</h5>
                    <p>{{ device.created_at|date:"Y-m-d H:i:s" }}</p>
                </div>

                <div class="col-md-6">
                    <div class="device-info mb-3">
                        <h5 class="text-muted">最后上线时间</h5>
                        {% if device.last_seen %}
                        <p>{{ device.last_seen|date:"Y-m-d H:i:s" }} ({{ device.last_seen|timesince }}前)</p>
                        {% else %}
                        <p>{{ "设备从未上线" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="device-info mb-3">
                        <h5 class="text-muted">设备ID</h5>
                        <div class="device-id-container">
                            <input type="text" class="form-control" value="{{ device.device_id }}" id="device_id" readonly>
                            <button class="btn btn-outline-primary copy-btn" type="button" onclick="copyToClipboard('device_id')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                    </div>

            <div class="device-info mb-3">
                        <h5 class="text-muted">设备密钥 <span class="text-danger">(重要，请妥善保管)</span></h5>
                        <div class="device-id-container">
                            <input type="text" class="form-control" value="{{ device.device_key }}" id="device_key" readonly>
                            <button class="btn btn-outline-primary copy-btn" type="button" onclick="copyToClipboard('device_key')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                        <small class="form-text text-muted">此密钥用于设备连接认证，请妥善保管，避免泄露。</small>
                    </div>
        </div>
    </div>

    <!-- 传感器部分 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">传感器列表</h4>
            <a href="{% url 'iot_devices:sensor_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                <i class="fas fa-plus"></i> 添加传感器
            </a>
        </div>
        <div class="card-body">
            {% if sensors %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>单位</th>
                                <th>数据键名</th>
                                <th>最新数据</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sensors_with_latest_data %}
                                <tr>
                                    <td>{{ item.sensor_info.name }}</td>
                                    <td>{{ item.sensor_info.sensor_type }}</td>
                                    <td>{{ item.sensor_info.unit }}</td>
                                    <td><code>{{ item.sensor_info.value_key }}</code></td>
                                    <td>
                                        {% if item.latest_value is not None %}
                                            <strong>{{ item.latest_value }}</strong>
                                            {% if item.sensor_info.unit %} {{ item.sensor_info.unit }}{% endif %}
                                            <span class="text-muted ml-2">({{ item.latest_data_record.timestamp|timesince }}前)</span>
                                        {% else %}
                                            <span class="text-muted">暂无数据</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'iot_devices:sensor_update' project.project_id device.device_id item.sensor_info.id %}" class="btn btn-outline-secondary btn-sm me-1">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'iot_devices:sensor_delete' project.project_id device.device_id item.sensor_info.id %}" class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('您确定要删除传感器 \'{{ item.sensor_info.name }}\' 吗？此操作不可恢复！');">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr class="chart-row">
                                    <td colspan="6" class="p-0">
                                        <div class="sensor-chart-container p-3" style="display:none;">
                                            <!-- 时间范围选择器 -->
                                            <div class="mb-3">
                                                <div class="btn-group sensor-data-range-selector" role="group">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm active" data-range="1h" data-sensor-id="{{ item.sensor_info.id }}" data-chart-canvas-id="sensorChart{{ item.sensor_info.id }}">1小时</button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="6h" data-sensor-id="{{ item.sensor_info.id }}" data-chart-canvas-id="sensorChart{{ item.sensor_info.id }}">6小时</button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="24h" data-sensor-id="{{ item.sensor_info.id }}" data-chart-canvas-id="sensorChart{{ item.sensor_info.id }}">24小时</button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="7d" data-sensor-id="{{ item.sensor_info.id }}" data-chart-canvas-id="sensorChart{{ item.sensor_info.id }}">7天</button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="30d" data-sensor-id="{{ item.sensor_info.id }}" data-chart-canvas-id="sensorChart{{ item.sensor_info.id }}">30天</button>
                                                </div>
                                            </div>
                                            
                                            <!-- 加载指示器 -->
                                            <div class="chart-loading text-center py-5" id="loading{{ item.sensor_info.id }}">
                                                <div class="spinner"></div>
                                                <p class="mt-2 text-muted">加载数据中...</p>
                                            </div>
                                            
                                            <!-- 图表容器 -->
                                            <div class="chart-wrapper" style="height: 300px;">
                                                <canvas id="sensorChart{{ item.sensor_info.id }}"></canvas>
                                            </div>
                                            
                                            <!-- 无数据提示 -->
                                            <div class="no-data-message text-center py-5" style="display: none;" id="noData{{ item.sensor_info.id }}">
                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">当前时间范围内没有数据</p>
                                            </div>
                                        </div>
                                        
                                        <!-- 图表切换器按钮 -->
                                        <div class="text-center py-2 chart-toggle-btn" data-target="sensorChart{{ item.sensor_info.id }}">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-chart-line"></i> 显示历史数据
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center">
                    <p class="text-muted mb-3">该设备还没有添加任何传感器</p>
                    <a href="{% url 'iot_devices:sensor_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> 添加第一个传感器
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 执行器部分 -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">执行器列表</h4>
            <a href="{% url 'iot_devices:actuator_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                <i class="fas fa-plus"></i> 添加执行器
            </a>
        </div>
        <div class="card-body">
            {% if actuators %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>命令键名</th>
                                <th>当前状态</th>
                                <th style="min-width: 220px;">控制</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for actuator in actuators %}
                                <tr>
                                    <td>{{ actuator.name }}</td>
                                    <td>{{ actuator.actuator_type }}</td>
                                    <td><code>{{ actuator.command_key }}</code></td>
                                    <td>
                                        {% if actuator.current_state_payload %}
                                            <code>{{ actuator.current_state_payload }}</code>
                                        {% else %}
                                            <span class="text-muted">未知</span>
                                        {% endif %}
                                    </td>
                                    <td class="actuator-control-cell">
                                        <!-- 根据执行器类型显示不同的控制界面 -->
                                        {% if actuator.actuator_type == 'switch' %}
                                            <!-- 开关类型控制 -->
                                            <div class="btn-group">
                                                <button class="btn btn-success btn-sm actuator-control-btn me-1" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-value="ON"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-power-off"></i> 开
                                                </button>
                                                <button class="btn btn-danger btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-value="OFF"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-power-off"></i> 关
                                                </button>
                                            </div>
                                        {% elif actuator.actuator_type == 'dimmer' %}
                                            <!-- 调光器类型控制 -->
                                            <div class="input-group input-group-sm actuator-input-group">
                                                <input type="number" class="form-control form-control-sm" 
                                                       id="dimmer-value-{{ actuator.id }}" 
                                                       min="0" max="100" value="50" placeholder="0-100">
                                                <button class="btn btn-primary btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-target-input-id="dimmer-value-{{ actuator.id }}"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-check"></i> 设置
                                                </button>
                                            </div>
                                        {% else %}
                                            <!-- 通用控制 -->
                                            <div class="input-group input-group-sm actuator-input-group">
                                                <input type="text" class="form-control form-control-sm" 
                                                       id="generic-value-{{ actuator.id }}" 
                                                       placeholder="输入命令值">
                                                <button class="btn btn-primary btn-sm actuator-control-btn" 
                                                        data-actuator-id="{{ actuator.id }}" 
                                                        data-command-target-input-id="generic-value-{{ actuator.id }}"
                                                        data-api-url="{% url 'iot_devices:actuator_command_api' project_id=device.project.project_id device_id=device.device_id actuator_id=actuator.id %}">
                                                    <i class="fas fa-paper-plane"></i> 发送
                                                </button>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'iot_devices:actuator_update' project.project_id device.device_id actuator.id %}" class="btn btn-outline-secondary btn-sm me-1" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'iot_devices:actuator_delete' project.project_id device.device_id actuator.id %}" class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('您确定要删除执行器 \'{{ actuator.name }}\' 吗？此操作不可恢复！');" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center">
                    <p class="text-muted mb-3">该设备还没有添加任何执行器</p>
                    <a href="{% url 'iot_devices:actuator_add' project.project_id device.device_id %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> 添加第一个执行器
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* 复制按钮样式，支持明暗主题 */
    .copy-btn {
        color: var(--color-primary);
        border-color: var(--color-primary);
        min-width: 80px;
        margin-left: 10px;
    }
    
    .copy-btn:hover {
        background-color: var(--color-primary);
        color: var(--text-on-primary);
    }
    
    /* 设备ID/密钥容器 */
    .device-id-container {
        display: flex;
        align-items: center;
        width: 100%;
    }
    
    .device-id-container .form-control {
        flex: 1;
    }
    
    /* 复制提示样式 */
    .copy-tooltip {
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    /* 执行器控制相关样式 */
    .input-group-sm .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* 执行器输入组样式 - 确保不换行 */
    .actuator-input-group {
        display: flex;
        flex-wrap: nowrap !important;
        width: 100%;
    }
    
    .actuator-input-group .form-control {
        min-width: 80px;
        max-width: 120px;
        flex-shrink: 1;
    }
    
    .actuator-input-group .btn {
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .actuator-control-cell {
        min-width: 220px;
        width: 220px;
    }
    
    /* 命令反馈提示样式 */
    .command-feedback {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .command-feedback.success {
        background-color: var(--color-success, #28a745);
        color: white;
    }
    
    .command-feedback.error {
        background-color: var(--color-danger, #dc3545);
        color: white;
    }
    
    /* 操作按钮中的图标与文本间隔 */
    .btn i {
        margin-right: 4px;
    }
</style>

{% block extra_body_js %}
<!-- 引入Chart.js库 -->
<script src="{% static 'libs/chartjs/chart.min.js' %}"></script>

<script>
// 用于复制设备ID和密钥的函数
    function copyToClipboard(elementId) {
    var copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999); /* For mobile devices */
        document.execCommand("copy");
    
    // 复制成功提示
    var btn = document.querySelector(`#${elementId}`).nextElementSibling;
    var originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
    setTimeout(function() {
        btn.innerHTML = originalText;
    }, 2000);
}

// 存储创建的图表实例
let sensorCharts = {};

// 获取CSS变量的辅助函数
function getCssVariable(variableName) {
    return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
}

// 渲染传感器图表函数
function renderSensorChart(sensorId, chartCanvasId, timeRange = '1h') {
    // 显示加载指示器
    const loadingElement = document.getElementById(`loading${sensorId}`);
    const chartElement = document.getElementById(chartCanvasId);
    const noDataElement = document.getElementById(`noData${sensorId}`);
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (noDataElement) noDataElement.style.display = 'none';
    
    // 获取CSRF token以发送Ajax请求
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // 构建API URL
    const projectId = '{{ project.project_id }}';
    const deviceId = '{{ device.device_id }}';
    const apiUrl = `/api/projects/${projectId}/devices/${deviceId}/sensors/${sensorId}/data/?range=${timeRange}`;
    
    // 使用Fetch API发送请求
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('网络响应异常');
        }
        return response.json();
    })
    .then(data => {
        // 隐藏加载指示器
        if (loadingElement) loadingElement.style.display = 'none';
        
        // 如果没有数据，显示无数据提示
        if (!data.labels || data.labels.length === 0) {
            if (noDataElement) {
                noDataElement.querySelector('p').textContent = '当前时间范围内没有数据';
                noDataElement.style.display = 'block';
            }
            return;
        }
        
        // 如果已存在图表实例，则销毁它
        if (sensorCharts[sensorId]) {
            sensorCharts[sensorId].destroy();
        }
        
        // 获取当前主题的颜色变量
        const isDarkMode = document.body.classList.contains('dark-mode') || 
                           document.documentElement.classList.contains('theme-dark') || 
                           document.documentElement.getAttribute('data-theme') === 'dark';
        
        // 准备图表颜色
        const primaryColor = getCssVariable('--color-primary');
        const primaryColorRgb = getCssVariable('--color-primary-rgb');
        const textColorDefault = getCssVariable('--text-default');
        const textColorMuted = getCssVariable('--text-muted');
        const borderColorDefault = getCssVariable('--border-default');
        const backgroundColorDefault = getCssVariable('--background-default');
        
        // 图表Label显示单位
        let labelDisplay = data.sensor_name;
        if (data.sensor_unit) {
            labelDisplay += ` (${data.sensor_unit})`;
        }
        
        // 确定是否为数值型数据（用于设置Y轴参数）
        const isNumericData = typeof data.values[0] === 'number';
        
        // 获取Canvas上下文
        const ctx = chartElement.getContext('2d');
        
        // 创建Chart实例
        sensorCharts[sensorId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: labelDisplay,
                    data: data.values,
                    borderColor: primaryColor,
                    backgroundColor: `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`,
                    borderWidth: 2,
                    pointRadius: data.labels.length > 50 ? 1 : 3, // 大量数据点时减小点的大小
                    pointHoverRadius: 5,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            color: `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`,
                            borderColor: borderColorDefault
                        },
                        ticks: {
                            color: textColorMuted || '#6a737d',
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            },
                            // 调整X轴标签数量，避免过于密集
                            maxTicksLimit: timeRange === '30d' ? 10 : (timeRange === '7d' ? 14 : 24)
                        }
                    },
                    y: {
                        beginAtZero: isNumericData ? (Math.min(...data.values.filter(v => typeof v === 'number')) > 0) : false,
                        grid: {
                            color: `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`,
                            borderColor: borderColorDefault
                        },
                        ticks: {
                            color: textColorMuted || '#6a737d',
                            // 为数值数据添加单位
                            callback: function(value) {
                                if (isNumericData && data.sensor_unit) {
                                    return value + ' ' + data.sensor_unit;
                                }
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: textColorDefault || '#24292f',
                            font: {
                                family: getCssVariable('--font-family-sans-serif')
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: backgroundColorDefault || '#ffffff',
                        titleColor: textColorDefault || '#24292f',
                        bodyColor: textColorDefault || '#24292f',
                        borderColor: borderColorDefault || '#d0d7de',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: {
                            family: getCssVariable('--font-family-sans-serif')
                        },
                        bodyFont: {
                            family: getCssVariable('--font-family-sans-serif')
                        },
                        callbacks: {
                            // 为数值数据添加单位
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                    if (isNumericData && data.sensor_unit) {
                                        label += ' ' + data.sensor_unit;
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: 250
                }
            }
        });
        
        // 显示数据统计信息（可选）
        console.log(`已显示 ${data.data_count}/${data.total_records} 个数据点`);
    })
    .catch(error => {
        console.error('获取图表数据失败:', error);
        if (loadingElement) loadingElement.style.display = 'none';
        if (noDataElement) {
            noDataElement.querySelector('p').textContent = '获取数据失败，请稍后再试';
            noDataElement.style.display = 'block';
        }
    });
}

// 文档加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 图表折叠切换功能
    const toggleButtons = document.querySelectorAll('.chart-toggle-btn button');
    toggleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // 找到对应的图表容器
            const chartId = this.closest('.chart-toggle-btn').dataset.target;
            const chartContainer = this.closest('tr').querySelector('.sensor-chart-container');
            
            if (chartContainer.style.display === 'none') {
                // 显示图表
                chartContainer.style.display = 'block';
                this.innerHTML = '<i class="fas fa-chart-line"></i> 隐藏历史数据';
                
                // 获取传感器ID和图表Canvas ID
                const sensorId = chartId.replace('sensorChart', '');
                
                // 渲染图表
                renderSensorChart(sensorId, chartId, '1h');
            } else {
                // 隐藏图表
                chartContainer.style.display = 'none';
                this.innerHTML = '<i class="fas fa-chart-line"></i> 显示历史数据';
            }
        });
    });
    
    // 时间范围选择器功能
    const rangeButtons = document.querySelectorAll('.sensor-data-range-selector button');
    rangeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const sensorId = this.dataset.sensorId;
            const chartCanvasId = this.dataset.chartCanvasId;
            const timeRange = this.dataset.range;
            
            // 更新按钮激活状态
            const parentGroup = this.closest('.sensor-data-range-selector');
            parentGroup.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            // 重新渲染图表
            renderSensorChart(sensorId, chartCanvasId, timeRange);
        });
    });
    
    // 执行器控制按钮功能
    const actuatorControlButtons = document.querySelectorAll('.actuator-control-btn');
    actuatorControlButtons.forEach(button => {
        button.addEventListener('click', function() {
            const actuatorId = this.dataset.actuatorId;
            const apiUrl = this.dataset.apiUrl;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // 获取命令值
            let commandValue = this.dataset.commandValue;
            
            // 如果命令值需要从输入框获取
            if (this.dataset.commandTargetInputId) {
                const inputField = document.getElementById(this.dataset.commandTargetInputId);
                commandValue = inputField.value;
                
                // 验证输入值不能为空
                if (!commandValue || commandValue.trim() === '') {
                    showToast('请输入有效的命令值', 'warning');
                    inputField.focus();
                    return;
                }
            }
            
            // 设置按钮加载状态
            setButtonLoading(this, true);
            
            // 发送控制命令
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    value: commandValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    if (data.status === 'success') {
                    // 显示成功通知
                    showToast(`命令已发送: ${commandValue}`, 'success');
                    } else {
                    // 显示错误通知
                    showToast(data.message || '命令发送失败', 'error');
                    }
                })
                .catch(error => {
                console.error('控制命令发送失败:', error);
                // 显示错误通知
                showToast('命令发送失败，请稍后重试', 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                setButtonLoading(this, false);
                
                // 如果是输入框，清空输入
                if (this.dataset.commandTargetInputId) {
                    const inputField = document.getElementById(this.dataset.commandTargetInputId);
                    if (inputField) {
                        inputField.value = '';
                    }
                }
            });
        });
    });
});

// 监听主题变化，更新所有图表
function updateChartsForTheme() {
    const currentTheme = document.body.classList.contains('dark-mode') || 
                       document.documentElement.classList.contains('theme-dark') || 
                       document.documentElement.getAttribute('data-theme') === 'dark'
                       ? 'dark' : 'light';
    
    // 遍历所有已创建的图表并更新
    Object.keys(sensorCharts).forEach(sensorId => {
        if (sensorCharts[sensorId]) {
            // 更新图表的颜色设置
            const chart = sensorCharts[sensorId];
            if (chart.config && chart.config.options) {
                // 获取更新后的颜色变量
                const primaryColor = getCssVariable('--color-primary');
                const primaryColorRgb = getCssVariable('--color-primary-rgb');
                const textColorDefault = getCssVariable('--text-default');
                const textColorMuted = getCssVariable('--text-muted');
                const borderColorDefault = getCssVariable('--border-default');
                const backgroundColorDefault = getCssVariable('--background-default');
                
                // 更新数据集颜色
                if (chart.data && chart.data.datasets && chart.data.datasets.length > 0) {
                    chart.data.datasets[0].borderColor = primaryColor;
                    chart.data.datasets[0].backgroundColor = `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`;
                }
                
                // 更新网格线和文本颜色
                if (chart.options.scales) {
                    // X轴
                    if (chart.options.scales.x) {
                        chart.options.scales.x.grid.color = `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`;
                        chart.options.scales.x.grid.borderColor = borderColorDefault;
                        chart.options.scales.x.ticks.color = textColorMuted;
                    }
                    // Y轴
                    if (chart.options.scales.y) {
                        chart.options.scales.y.grid.color = `rgba(${primaryColorRgb || '52, 152, 219'}, 0.1)`;
                        chart.options.scales.y.grid.borderColor = borderColorDefault;
                        chart.options.scales.y.ticks.color = textColorMuted;
                    }
                }
                
                // 更新图例和提示框颜色
                if (chart.options.plugins) {
                    // 图例
                    if (chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = textColorDefault;
                    }
                    // 提示框
                    if (chart.options.plugins.tooltip) {
                        chart.options.plugins.tooltip.backgroundColor = backgroundColorDefault;
                        chart.options.plugins.tooltip.titleColor = textColorDefault;
                        chart.options.plugins.tooltip.bodyColor = textColorDefault;
                        chart.options.plugins.tooltip.borderColor = borderColorDefault;
                    }
                }
            }
            
            // 应用更新
            sensorCharts[sensorId].update();
        }
    });
    
    // 将主题状态记录在控制台，方便调试
    console.log(`主题已切换为: ${currentTheme}`);
}

// 监听body上的class变化，检测主题变化
const observer = new MutationObserver(mutations => {
    let themeChanged = false;
    
    mutations.forEach(mutation => {
        if (mutation.attributeName === 'class' || mutation.attributeName === 'data-theme') {
            themeChanged = true;
        }
    });
    
    if (themeChanged) {
        // 主题变化时更新图表
        updateChartsForTheme();
    }
});

// 开始监听body的class变化
observer.observe(document.body, { attributes: true });

// 同时监听html元素的主题属性变化
observer.observe(document.documentElement, { attributes: true });
</script>
{% endblock %}
{% endblock %} 