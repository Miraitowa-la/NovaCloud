{% extends 'base.html' %}

{% block title %}配置策略：{{ strategy.name }} - NovaCloud{% endblock %}

{% block extra_head_css %}
<style>
    /* 基础组件样式 */
    .condition-group {
        background-color: var(--background-muted);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 2px solid var(--border-color);
        position: relative;
    }
    
    .condition {
        background-color: var(--background-default);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        position: relative;
    }
    
    /* 条件内的表单控件样式 */
    .condition .form-control,
    .condition .form-select {
        background-color: var(--background-muted);
    }
    
    /* 深色模式下的表单控件背景调整 */
    html[data-theme='dark'] .condition .form-control,
    html[data-theme='dark'] .condition .form-select,
    body.dark-mode .condition .form-control,
    body.dark-mode .condition .form-select {
        background-color: rgba(0, 0, 0, 0.2);
        border-color: var(--border-color);
    }
    
    .action-card {
        background-color: var(--background-muted);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 2px solid var(--border-color);
        position: relative;
    }
    
    /* 头部和操作区 */
    .component-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    /* 逻辑运算符标签 */
    .logic-operator-badge {
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        background-color: var(--color-primary);
        color: var(--text-on-primary);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
    }
    
    /* 添加按钮样式 */
    .btn-add {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin: 1rem 0;
        padding: 0.75rem;
        background-color: var(--background-hover);
        border: 1px dashed var(--border-color);
        color: var(--text-muted);
        border-radius: var(--border-radius-md);
        transition: all 0.2s;
    }
    
    .btn-add:hover {
        background-color: var(--background-active);
        color: var(--text-default);
    }
    
    /* 为添加条件按钮增加特殊样式 */
    .add-condition {
        margin: 0;
        width: 100%;
        border: 1px dashed var(--border-color);
        background-color: var(--background-default);
    }
    
    /* 表单字段容器 */
    .field-group {
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    /* 隐藏的表单组 */
    .hidden-field-group {
        display: none !important; /* Important 用于覆盖 Django 小部件可能设置的任何内联样式 */
    }
    
    /* 代码编辑器样式 */
    .code-editor {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 0.9rem;
        background-color: var(--background-muted);
        color: var(--text-default);
        min-height: 100px; /* 确保文本区域可见 */
        padding: 0.75rem;
        line-height: 1.5;
        tab-size: 2;
        -moz-tab-size: 2;
        overflow-x: auto; /* 允许横向滚动，避免长行的自动换行 */
        white-space: pre; /* 保持空格和换行格式 */
    }
    
    html[data-theme='dark'] .code-editor, 
    body.dark-mode .code-editor {
        background-color: rgba(0, 0, 0, 0.2); /* 稍微暗一些的背景，增强可读性 */
    }
    
    /* 错误提示 */
    .error-message {
        color: var(--color-danger);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* 暗模式下删除按钮样式优化 */
    html[data-theme='dark'] .btn-outline-danger,
    body.dark-mode .btn-outline-danger {
        color: #adb5bd; /* 柔和的灰白色 */
        border-color: #adb5bd;
    }
    
    html[data-theme='dark'] .btn-outline-danger:hover,
    body.dark-mode .btn-outline-danger:hover {
        background-color: rgba(173, 181, 189, 0.2); /* 半透明背景 */
        color: #ced4da; /* 悬停时稍微亮一点 */
        border-color: #ced4da;
    }
    
    /* Toast通知样式 */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background-color: var(--background-default);
        color: var(--text-default);
        border-left: 4px solid var(--color-primary);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        padding: 12px 20px;
        margin-bottom: 10px;
        min-width: 250px;
        max-width: 350px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease-in-out;
        white-space: pre-line; /* 允许换行 */
        line-height: 1.4;
        max-height: 80vh; /* 限制最大高度 */
        overflow-y: auto; /* 内容过多时允许滚动 */
    }
    
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    
    .toast.success {
        border-left-color: var(--color-success);
    }
    
    .toast.error {
        border-left-color: var(--color-danger);
    }
    
    .toast.warning {
        border-left-color: var(--color-warning);
    }
    
    .toast.info {
        border-left-color: var(--color-info);
    }
    
    /* 加载动画 */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000; /* 比 toast 高 */
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .loading-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--background-muted);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 确保 Django 表单小部件具有一些基础样式 */
    .form-control, .form-select {
        /* 使用类似 Bootstrap 的类名进行通用样式设置 */
        display: block;
        width: 100%;
        padding: .375rem .75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: var(--text-default);
        background-color: var(--background-default);
        background-clip: padding-box;
        border: 1px solid var(--border-color);
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: var(--border-radius-md);
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--color-primary);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(var(--color-primary-rgb), 0.25); /* 假设 --color-primary-rgb 已定义 */
    }
    textarea.form-control {
        min-height: calc(1.5em + .75rem + 2px);
    }
    .form-label {
        margin-bottom: 0.5rem;
        display: inline-block;
    }
    .form-text {
        font-size: .875em;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 页面头部 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>配置策略：{{ strategy.name }}</h2>
        <div>
            <a href="{% url 'strategy_engine:execution_log_list' %}?strategy_id={{ strategy.id }}" class="btn btn-outline-primary">
                <i class="fas fa-clipboard-list"></i> 查看此策略的执行日志
            </a>
        </div>
    </div>
    
    <!-- 策略基本信息卡片 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">策略信息</h4>
            <a href="{% url 'strategy_engine:strategy_update' strategy.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit"></i> 编辑基本信息
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="mb-0">
                        <dt>策略名称</dt>
                        <dd>{{ strategy.name }}</dd>
                        
                        <dt class="mt-3">所属项目</dt>
                        <dd>{{ strategy.project.name }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="mb-0">
                        <dt>触发类型</dt>
                        <dd>{{ strategy.get_trigger_type_display }}</dd>
                        
                        <dt class="mt-3">状态</dt>
                        <dd>
                            {% if strategy.is_enabled %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> 已启用</span>
                            {% else %}
                            <span class="text-secondary"><i class="fas fa-times-circle"></i> 已禁用</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
                {% if strategy.description %}
                <div class="col-12 mt-3">
                    <dt>描述</dt>
                    <dd>{{ strategy.description }}</dd>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 主表单 -->
    <form method="post" id="strategyConfigForm">
        {% csrf_token %}
        
        <!-- 条件配置卡片 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h4 class="card-title mb-0">条件配置</h4>
            </div>
            <div class="card-body">
                <p class="mb-4">配置触发此策略的条件。您可以添加多个条件组，每个条件组内可以有多个条件。</p>
                
                <!-- 条件组表单集 -->
                <div id="conditionGroupsContainer">
                {{ condition_group_formset.management_form }}
                
                {% for group_form in condition_group_formset %}
                    <div class="condition-group" id="group-{{ forloop.counter0 }}" data-group-prefix="conditiongroup_set-{{ forloop.counter0 }}">
                        {% for hidden_field in group_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        
                        <div class="component-header">
                            <h5 class="mb-0 group-title">条件组 {{ forloop.counter }}</h5>
                            <button type="button" class="btn btn-outline-danger delete-group">
                                <i class="fas fa-trash"></i> 删除条件组
                            </button>
                            <!-- {{ group_form.DELETE.as_hidden }} 将由JS为新表单处理 -->
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="{{ group_form.logical_operator.id_for_label }}" class="form-label">
                                    逻辑运算符
                                </label>
                                {{ group_form.logical_operator }}
                                <div class="form-text text-muted">此组内条件的关系：全部满足(AND) 或 任一满足(OR)</div>
                                {% if group_form.logical_operator.errors %}
                                <div class="error-message">
                                        {% for error in group_form.logical_operator.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ group_form.execution_order.id_for_label }}" class="form-label">
                                    执行顺序
                                </label>
                                {{ group_form.execution_order }}
                                <div class="form-text text-muted">多个条件组的评估顺序，数字越小越先评估</div>
                                {% if group_form.execution_order.errors %}
                                <div class="error-message">
                                        {% for error in group_form.execution_order.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 条件表单集 -->
                        <div class="conditions-container">
                            {{ group_form.nested_condition_formset.management_form }}
                            
                            <h6 class="mb-3">条件列表：</h6>
                            
                            {% for condition_form in group_form.nested_condition_formset %}
                            <div class="condition" id="condition-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}" data-group-id="{{ forloop.parentloop.counter0 }}" data-condition-id="{{ forloop.counter0 }}">
                                    {% for hidden_field in condition_form.hidden_fields %}
                                        {{ hidden_field }}
                                    {% endfor %}
                                    
                                <div class="component-header">
                                        <h6 class="mb-0 condition-title">条件 {{ forloop.counter }}</h6>
                                    <button type="button" class="btn btn-outline-danger delete-condition">
                                        <i class="fas fa-trash"></i> 删除条件
                                    </button>
                                    <!-- {{ condition_form.DELETE.as_hidden }} -->
                                    </div>
                                    
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="{{ condition_form.data_source_type.id_for_label }}" class="form-label">数据源类型</label>
                                            {{ condition_form.data_source_type }}
                                            {% if condition_form.data_source_type.errors %}
                                        <div class="error-message">
                                                    {% for error in condition_form.data_source_type.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                <!-- 数据源相关字段组 -->
                                <div class="field-group source-fields source-sensor-fields" data-source-type="sensor">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.sensor.id_for_label }}" class="form-label">传感器</label>
                                            {{ condition_form.sensor }}
                                            {% if condition_form.sensor.errors %}
                                            <div class="error-message">
                                                    {% for error in condition_form.sensor.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        </div>
                                        
                                <div class="field-group source-fields source-device-fields hidden-field-group" data-source-type="device_attribute">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.device_attribute.id_for_label }}" class="form-label">设备属性</label>
                                            {{ condition_form.device_attribute }}
                                            {% if condition_form.device_attribute.errors %}
                                            <div class="error-message">
                                                    {% for error in condition_form.device_attribute.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 时间类型数据源 -->
                                <div class="field-group source-fields source-time-fields hidden-field-group" data-source-type="time_of_day">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.time_of_day.id_for_label|default:'id_time_of_day' }}" class="form-label">一天中的时间</label>
                                            <input type="time" name="{{ condition_form.prefix }}-time_of_day" id="{{ condition_form.time_of_day.id_for_label|default:'id_time_of_day' }}" class="form-control" placeholder="HH:MM" value="{{ condition_form.time_of_day.value|default:'' }}">
                                            <div class="form-text text-muted">24小时格式的时间点，例如：14:30表示下午2:30</div>
                                            {% if condition_form.time_of_day.errors %}
                                            <div class="error-message">
                                                {% for error in condition_form.time_of_day.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field-group source-fields source-specific-time-fields hidden-field-group" data-source-type="specific_time">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.specific_time.id_for_label|default:'id_specific_time' }}" class="form-label">特定时间点</label>
                                            <input type="datetime-local" name="{{ condition_form.prefix }}-specific_time" id="{{ condition_form.specific_time.id_for_label|default:'id_specific_time' }}" class="form-control" value="{{ condition_form.specific_time.value|default:'' }}">
                                            <div class="form-text text-muted">选择特定的日期和时间触发</div>
                                            {% if condition_form.specific_time.errors %}
                                            <div class="error-message">
                                                {% for error in condition_form.specific_time.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        </div>
                                        
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ condition_form.operator.id_for_label }}" class="form-label">比较运算符</label>
                                            {{ condition_form.operator }}
                                            {% if condition_form.operator.errors %}
                                        <div class="error-message">
                                                    {% for error in condition_form.operator.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ condition_form.threshold_value_type.id_for_label }}" class="form-label">阈值类型</label>
                                            {{ condition_form.threshold_value_type }}
                                            {% if condition_form.threshold_value_type.errors %}
                                        <div class="error-message">
                                                    {% for error in condition_form.threshold_value_type.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                <!-- 阈值相关字段组 -->
                                <div class="field-group threshold-fields threshold-static-fields" data-threshold-type="static">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.threshold_value_static.id_for_label }}" class="form-label">静态阈值</label>
                                            {{ condition_form.threshold_value_static }}
                                            {% if condition_form.threshold_value_static.errors %}
                                            <div class="error-message">
                                                    {% for error in condition_form.threshold_value_static.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        </div>
                                        
                                <div class="field-group threshold-fields threshold-sensor-fields hidden-field-group" data-threshold-type="sensor_value">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.threshold_value_sensor.id_for_label }}" class="form-label">对比传感器</label>
                                            {{ condition_form.threshold_value_sensor }}
                                            {% if condition_form.threshold_value_sensor.errors %}
                                            <div class="error-message">
                                                    {% for error in condition_form.threshold_value_sensor.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        </div>
                                        
                                <div class="field-group threshold-fields threshold-device-fields hidden-field-group" data-threshold-type="device_attribute_value">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="{{ condition_form.threshold_value_device_attribute.id_for_label }}" class="form-label">对比设备属性</label>
                                            {{ condition_form.threshold_value_device_attribute }}
                                            {% if condition_form.threshold_value_device_attribute.errors %}
                                            <div class="error-message">
                                                    {% for error in condition_form.threshold_value_device_attribute.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <button type="button" class="btn-add add-condition">
                                <i class="fas fa-plus me-2"></i> 添加条件
                            </button>
                        </div>
                    </div>
                {% endfor %}
                </div>
                
                <button type="button" class="btn-add add-group">
                    <i class="fas fa-plus-circle me-2"></i> 添加条件组
                </button>
            </div>
        </div>
        
        <!-- 动作配置卡片 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h4 class="card-title mb-0">动作配置</h4>
            </div>
            <div class="card-body">
                <p class="mb-4">配置当条件满足时要执行的动作。您可以添加多个动作，并设置它们的执行顺序。</p>
                
                <!-- 动作表单集 -->
                <div id="actionsContainer">
                {{ action_formset.management_form }}
                
                {% for action_form in action_formset %}
                    <div class="action-card" id="action-{{ forloop.counter0 }}" data-action-prefix="{{ action_form.prefix }}">
                        {% for hidden_field in action_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        
                        <div class="component-header">
                                <h5 class="mb-0 action-title">动作 {{ forloop.counter }}</h5>
                            <button type="button" class="btn btn-outline-danger delete-action">
                                <i class="fas fa-trash"></i> 删除动作
                            </button>
                            <!-- {{ action_form.DELETE.as_hidden }} -->
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                <label for="{{ action_form.action_type.id_for_label }}" class="form-label">动作类型</label>
                                    {{ action_form.action_type }}
                                <div class="form-text text-muted">选择要执行的动作类型</div>
                                    {% if action_form.action_type.errors %}
                                <div class="error-message">
                                            {% for error in action_form.action_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                <label for="{{ action_form.execution_order.id_for_label }}" class="form-label">执行顺序</label>
                                    {{ action_form.execution_order }}
                                <div class="form-text text-muted">多个动作的执行顺序，数字越小越先执行</div>
                                    {% if action_form.execution_order.errors %}
                                <div class="error-message">
                                            {% for error in action_form.execution_order.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- 控制执行器相关字段组 -->
                        <div class="field-group action-fields action-actuator-fields" data-action-type="control_actuator">
                                <h6 class="mb-3">执行器控制参数</h6>
                                
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="{{ action_form.target_actuator.id_for_label }}" class="form-label">目标执行器</label>
                                    {{ action_form.target_actuator }}
                                    <div class="form-text text-muted">选择要控制的执行器</div>
                                    {% if action_form.target_actuator.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.target_actuator.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                                
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="{{ action_form.command_payload_template.id_for_label }}" class="form-label">命令内容模板 (JSON)</label>
                                    {{ action_form.command_payload_template }}
                                    <div class="form-text text-muted">JSON格式的命令内容，可以使用模板变量如 {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}sensor.name{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}project.name{% templatetag closevariable %}, {% templatetag openvariable %}now{% templatetag closevariable %}</div>
                                    {% if action_form.command_payload_template.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.command_payload_template.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                            </div>
                            
                            <!-- 发送通知相关字段组 -->
                        <div class="field-group action-fields action-notification-fields hidden-field-group" data-action-type="send_notification">
                                <h6 class="mb-3">通知参数</h6>
                                
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ action_form.notification_recipient_type.id_for_label }}" class="form-label">接收者类型</label>
                                    {{ action_form.notification_recipient_type }}
                                    <div class="form-text text-muted">选择通知的接收者类型</div>
                                    {% if action_form.notification_recipient_type.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.notification_recipient_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ action_form.notification_recipient_value.id_for_label }}" class="form-label">接收者值</label>
                                    {{ action_form.notification_recipient_value }}
                                    <div class="form-text text-muted">接收者的值，如邮箱地址、电话号码等</div>
                                    {% if action_form.notification_recipient_value.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.notification_recipient_value.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                                
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="{{ action_form.notification_message_template.id_for_label }}" class="form-label">通知内容模板</label>
                                    {{ action_form.notification_message_template }}
                                    <div class="form-text text-muted">通知内容，可以使用模板变量如 {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}device.status{% templatetag closevariable %}, {% templatetag openvariable %}condition_text{% templatetag closevariable %}, {% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}</div>
                                    {% if action_form.notification_message_template.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.notification_message_template.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                            </div>
                            
                            <!-- 调用Webhook相关字段组 -->
                        <div class="field-group action-fields action-webhook-fields hidden-field-group" data-action-type="call_webhook">
                                <h6 class="mb-3">Webhook参数</h6>
                                
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ action_form.webhook_url.id_for_label }}" class="form-label">Webhook URL</label>
                                    {{ action_form.webhook_url }}
                                    <div class="form-text text-muted">要调用的Webhook URL</div>
                                    {% if action_form.webhook_url.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.webhook_url.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ action_form.webhook_method.id_for_label }}" class="form-label">HTTP方法</label>
                                    {{ action_form.webhook_method }}
                                    <div class="form-text text-muted">HTTP请求方法</div>
                                    {% if action_form.webhook_method.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.webhook_method.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                                
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="{{ action_form.webhook_headers_template.id_for_label }}" class="form-label">请求头部模板 (JSON)</label>
                                    {{ action_form.webhook_headers_template }}
                                    <div class="form-text text-muted">JSON格式的HTTP请求头，可以使用模板变量如 {% templatetag openvariable %}strategy.id{% templatetag closevariable %}, {% templatetag openvariable %}project.id{% templatetag closevariable %}, {% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}。例如: {"Authorization": "Bearer secret_token", "X-Strategy-ID": "{% templatetag openvariable %}strategy.id{% templatetag closevariable %}"}</div>
                                    {% if action_form.webhook_headers_template.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.webhook_headers_template.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                                
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="{{ action_form.webhook_payload_template.id_for_label }}" class="form-label">请求体模板 (JSON)</label>
                                    {{ action_form.webhook_payload_template }}
                                    <div class="form-text text-muted">JSON格式的HTTP请求体，可以使用模板变量如 {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}condition_text{% templatetag closevariable %}。例如: {"event": "strategy_triggered", "strategy_name": "{% templatetag openvariable %}strategy.name{% templatetag closevariable %}", "triggered_value": "{% templatetag openvariable %}sensor.value{% templatetag closevariable %}", "timestamp": "{% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}"}</div>
                                    {% if action_form.webhook_payload_template.errors %}
                                    <div class="error-message">
                                            {% for error in action_form.webhook_payload_template.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
                
                <button type="button" class="btn-add add-action">
                    <i class="fas fa-plus-circle me-2"></i> 添加动作
                </button>
                
                <!-- 提交按钮 -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                </div>
            </div>
        </div>
    </form>
    
    <!-- 条件组模板 (用于复制) -->
    <!-- 这些模板本身不需要被翻译，因为它们是HTML结构，其中的占位符会被JS替换 -->
    <div id="group-template-wrapper" style="display: none;">
        {{ condition_group_formset.empty_form.as_p }}
    </div>
    
    <!-- 条件模板 (用于复制) -->
    <div id="condition-template-wrapper" style="display: none;">
        {% if condition_group_formset.forms %}{{ condition_group_formset.forms.0.nested_condition_formset.empty_form.as_p }}{% else %}{{ condition_group_formset.empty_form.nested_condition_formset.empty_form.as_p }}{% endif %}
    </div>
    
    <!-- 动作模板 (用于复制) -->
    <div id="action-template-wrapper" style="display: none;">
        {{ action_formset.empty_form.as_p }}
    </div>
    
    <!-- Toast通知容器 -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const conditionGroupsContainer = document.getElementById('conditionGroupsContainer');
    const actionsContainer = document.getElementById('actionsContainer');
    const addGroupButton = document.querySelector('.add-group');
    const addActionButton = document.querySelector('.add-action');
    const strategyConfigForm = document.getElementById('strategyConfigForm');

    // --- 模板 ---
    // 这些是空表单的原始HTML字符串，稍后我们会包装它们。
    const rawGroupTemplate = `{{ condition_group_formset.empty_form.as_ul }}`.replace(/<ul>|<\/ul>/g, ''); // 使用 as_ul 或 as_p 并剥离外部标签
    const rawConditionTemplate = `{% if condition_group_formset.forms %}{{ condition_group_formset.forms.0.nested_condition_formset.empty_form.as_ul }}{% else %}{{ condition_group_formset.empty_form.nested_condition_formset.empty_form.as_ul }}{% endif %}`.replace(/<ul>|<\/ul>/g, '');
    const rawActionTemplate = `{{ action_formset.empty_form.as_ul }}`.replace(/<ul>|<\/ul>/g, '');

    // 确保文本区域具有 code-editor 类
    function styleTextareas(element) {
        element.querySelectorAll('textarea').forEach(ta => {
            if (ta.id.includes('payload_template') || ta.id.includes('headers_template') || ta.id.includes('message_template')) {
                ta.classList.add('code-editor', 'form-control');
            } else {
                ta.classList.add('form-control');
            }
        });
        element.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]):not([type="hidden"]), select').forEach(inp => {
             if (!inp.classList.contains('btn')) { // 不要重新设置按钮样式
                inp.classList.add('form-control'); // 对于 select 标签使用 form-select
                if (inp.tagName === 'SELECT') inp.classList.add('form-select');
             }
        });
    }


    // --- 工具函数 ---
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10); // 用于过渡
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toast.remove(); }, 300);
        }, 3000);
    }

    function toggleLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }

    function updateManagementForm(prefix, increment = true) {
        const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        if (totalFormsInput) {
            let count = parseInt(totalFormsInput.value);
            totalFormsInput.value = increment ? count + 1 : count -1 ; // Django 处理删除，所以对于新添加项，总表单数总是增加
        }
    }

    function getNextIndex(prefix) {
        const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        return totalFormsInput ? parseInt(totalFormsInput.value) : 0;
    }

    // --- 动态字段可见性 ---
    function toggleConditionFields(conditionElement) {
        const dataSourceTypeSelect = conditionElement.querySelector('select[name$="-data_source_type"]');
        const thresholdValueTypeSelect = conditionElement.querySelector('select[name$="-threshold_value_type"]');

        // 数据源字段
        const selectedDataSourceType = dataSourceTypeSelect ? dataSourceTypeSelect.value : 'sensor'; // 如果未找到则默认为 'sensor'
        conditionElement.querySelectorAll('.source-fields').forEach(group => {
            if (group.dataset.sourceType === selectedDataSourceType) {
                group.classList.remove('hidden-field-group');
            } else {
                group.classList.add('hidden-field-group');
            }
        });

        // 阈值字段
        const selectedThresholdType = thresholdValueTypeSelect ? thresholdValueTypeSelect.value : 'static'; // 默认值
        conditionElement.querySelectorAll('.threshold-fields').forEach(group => {
            if (group.dataset.thresholdType === selectedThresholdType) {
                group.classList.remove('hidden-field-group');
            } else {
                group.classList.add('hidden-field-group');
            }
        });
    }

    function toggleActionFields(actionElement) {
        const actionTypeSelect = actionElement.querySelector('select[name$="-action_type"]');
        const selectedActionType = actionTypeSelect ? actionTypeSelect.value : 'control_actuator'; // 默认值

        actionElement.querySelectorAll('.action-fields').forEach(group => {
            if (group.dataset.actionType === selectedActionType) {
                group.classList.remove('hidden-field-group');
            } else {
                group.classList.add('hidden-field-group');
            }
        });
    }

    // --- 添加元素 ---
    function addConditionGroup() {
        const groupPrefix = 'conditiongroup_set'; // 主 formset 前缀
        const groupIndex = getNextIndex(groupPrefix);

        const tempDiv = document.createElement('div');
        // 将 __prefix__ 替换为组的实际索引
        tempDiv.innerHTML = rawGroupTemplate.replace(/__prefix__/g, groupIndex);

        const newGroupElement = document.createElement('div');
        newGroupElement.className = 'condition-group';
        newGroupElement.setAttribute('id', `group-${groupIndex}`);
        newGroupElement.setAttribute('data-group-prefix', `${groupPrefix}-${groupIndex}`); // 存储完整前缀

        // 手动构建组的 HTML 结构以获得更好的控制
        newGroupElement.innerHTML = `
            <input type="hidden" name="${groupPrefix}-${groupIndex}-id" id="id_${groupPrefix}-${groupIndex}-id">
            <input type="hidden" name="${groupPrefix}-${groupIndex}-strategy" value="{{ strategy.id }}" id="id_${groupPrefix}-${groupIndex}-strategy">
            <input type="hidden" name="${groupPrefix}-${groupIndex}-DELETE" id="id_${groupPrefix}-${groupIndex}-DELETE">
            <div class="component-header">
                <h5 class="mb-0 group-title">条件组 ${conditionGroupsContainer.querySelectorAll('.condition-group:not([style*="display: none"])').length + 1}</h5>
                <button type="button" class="btn btn-outline-danger delete-group">
                    <i class="fas fa-trash"></i> 删除条件组
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    ${tempDiv.querySelector('li:nth-child(1)')?.innerHTML || ''} <!-- logical_operator -->
                    <div class="form-text text-muted">此组内条件的关系：全部满足(AND) 或 任一满足(OR)</div>
                </div>
                <div class="col-md-6 mb-3">
                     ${tempDiv.querySelector('li:nth-child(2)')?.innerHTML || ''} <!-- execution_order -->
                    <div class="form-text text-muted">多个条件组的评估顺序，数字越小越先评估</div>
                </div>
            </div>
            <div class="conditions-container">
                <input type="hidden" name="${groupPrefix}-${groupIndex}-condition_set-TOTAL_FORMS" value="0" id="id_${groupPrefix}-${groupIndex}-condition_set-TOTAL_FORMS">
                <input type="hidden" name="${groupPrefix}-${groupIndex}-condition_set-INITIAL_FORMS" value="0" id="id_${groupPrefix}-${groupIndex}-condition_set-INITIAL_FORMS">
                <input type="hidden" name="${groupPrefix}-${groupIndex}-condition_set-MIN_NUM_FORMS" value="0" id="id_${groupPrefix}-${groupIndex}-condition_set-MIN_NUM_FORMS">
                <input type="hidden" name="${groupPrefix}-${groupIndex}-condition_set-MAX_NUM_FORMS" value="1000" id="id_${groupPrefix}-${groupIndex}-condition_set-MAX_NUM_FORMS">
                <h6 class="mb-3">条件列表：</h6>
                <!-- 条件将在此处添加 -->
                <button type="button" class="btn-add add-condition">
                    <i class="fas fa-plus me-2"></i> 添加条件
                </button>
            </div>
        `;
        styleTextareas(newGroupElement);
        conditionGroupsContainer.appendChild(newGroupElement);
        updateManagementForm(groupPrefix, true);
        addCondition(newGroupElement.querySelector('.add-condition')); // 添加一个默认条件
        bindEventListenersToGroup(newGroupElement);
        reindexConditionGroups();
    }

    function addCondition(addButtonElement) {
        const groupElement = addButtonElement.closest('.condition-group');
        const conditionsContainer = groupElement.querySelector('.conditions-container');
        const groupPrefix = groupElement.dataset.groupPrefix; // 例如, conditiongroup_set-0
        const conditionSubPrefix = `${groupPrefix}-condition_set`; // 例如, conditiongroup_set-0-condition_set
        const conditionIndex = getNextIndex(conditionSubPrefix);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawConditionTemplate.replace(/__prefix__/g, conditionIndex);

        const newConditionElement = document.createElement('div');
        newConditionElement.className = 'condition';
        newConditionElement.id = `condition-${groupElement.id.split('-')[1]}-${conditionIndex}`;
        newConditionElement.setAttribute('data-condition-prefix', `${conditionSubPrefix}-${conditionIndex}`);
        
        // 获取组ID（如果已有）
        const groupId = groupElement.querySelector('input[name$="-id"]').value || '';
        
        // 手动构建 HTML 以匹配期望的结构
        newConditionElement.innerHTML = `
            <input type="hidden" name="${conditionSubPrefix}-${conditionIndex}-id" id="id_${conditionSubPrefix}-${conditionIndex}-id">
            <input type="hidden" name="${conditionSubPrefix}-${conditionIndex}-group" id="id_${conditionSubPrefix}-${conditionIndex}-group" value="${groupId}"> 
            <input type="hidden" name="${conditionSubPrefix}-${conditionIndex}-DELETE" id="id_${conditionSubPrefix}-${conditionIndex}-DELETE">
            <div class="component-header">
                <h6 class="mb-0 condition-title">条件 ${conditionsContainer.querySelectorAll('.condition:not([style*="display: none"])').length + 1}</h6>
                <button type="button" class="btn btn-outline-danger delete-condition">
                    <i class="fas fa-trash"></i> 删除条件
                </button>
            </div>
            <div class="row"><div class="col-12 mb-3">${tempDiv.querySelector('li:nth-child(1)')?.innerHTML || ''}</div></div> <!-- data_source_type -->

            <div class="field-group source-fields source-sensor-fields" data-source-type="sensor"><div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(2)')?.innerHTML || ''}</div></div></div> <!-- sensor -->
            <div class="field-group source-fields source-device-fields hidden-field-group" data-source-type="device_attribute"><div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(3)')?.innerHTML || ''}</div></div></div> <!-- device_attribute -->
            
            <!-- 时间类型数据源 -->
            <div class="field-group source-fields source-time-fields hidden-field-group" data-source-type="time_of_day">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="id_${conditionSubPrefix}-${conditionIndex}-time_of_day" class="form-label">一天中的时间</label>
                        <input type="time" name="${conditionSubPrefix}-${conditionIndex}-time_of_day" id="id_${conditionSubPrefix}-${conditionIndex}-time_of_day" class="form-control" placeholder="HH:MM">
                        <div class="form-text text-muted">24小时格式的时间点，例如：14:30表示下午2:30</div>
                    </div>
                </div>
            </div>
            
            <div class="field-group source-fields source-specific-time-fields hidden-field-group" data-source-type="specific_time">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="id_${conditionSubPrefix}-${conditionIndex}-specific_time" class="form-label">特定时间点</label>
                        <input type="datetime-local" name="${conditionSubPrefix}-${conditionIndex}-specific_time" id="id_${conditionSubPrefix}-${conditionIndex}-specific_time" class="form-control">
                        <div class="form-text text-muted">选择特定的日期和时间触发</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(4)')?.innerHTML || ''}</div> <!-- operator -->
                <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(5)')?.innerHTML || ''}</div> <!-- threshold_value_type -->
            </div>

            <div class="field-group threshold-fields threshold-static-fields" data-threshold-type="static"><div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(6)')?.innerHTML || ''}</div></div></div> <!-- threshold_value_static -->
            <div class="field-group threshold-fields threshold-sensor-fields hidden-field-group" data-threshold-type="sensor_value"><div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(7)')?.innerHTML || ''}</div></div></div> <!-- threshold_value_sensor -->
            <div class="field-group threshold-fields threshold-device-fields hidden-field-group" data-threshold-type="device_attribute_value"><div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(8)')?.innerHTML || ''}</div></div></div> <!-- threshold_value_device_attribute -->
        `;

        // 如果条件组是新建的（没有ID），则添加临时引用字段
        if (!groupId) {
            console.log(`添加条件到新组 ${groupPrefix}，需要设置临时引用`);
            const tempConditionPrefix = `${conditionSubPrefix}-${conditionIndex}`;
            const tempGroupRefInput = document.createElement('input');
            tempGroupRefInput.type = 'hidden';
            tempGroupRefInput.name = `${tempConditionPrefix}-temp_group_ref`;
            tempGroupRefInput.value = groupPrefix;
            newConditionElement.appendChild(tempGroupRefInput);
        }

        styleTextareas(newConditionElement);
        // 插入到 "添加条件" 按钮之前
        conditionsContainer.insertBefore(newConditionElement, addButtonElement);
        updateManagementForm(conditionSubPrefix, true);
        bindEventListenersToCondition(newConditionElement);
        toggleConditionFields(newConditionElement); // 初始化字段可见性
        reindexConditionsInGroup(groupElement);
    }

    function addAction() {
        const actionPrefix = 'action_set';
        const actionIndex = getNextIndex(actionPrefix);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawActionTemplate.replace(/__prefix__/g, actionIndex);

        const newActionElement = document.createElement('div');
        newActionElement.className = 'action-card';
        newActionElement.id = `action-${actionIndex}`;
        newActionElement.setAttribute('data-action-prefix', `${actionPrefix}-${actionIndex}`);

        newActionElement.innerHTML = `
            <input type="hidden" name="${actionPrefix}-${actionIndex}-id" id="id_${actionPrefix}-${actionIndex}-id">
            <input type="hidden" name="${actionPrefix}-${actionIndex}-strategy" value="{{ strategy.id }}" id="id_${actionPrefix}-${actionIndex}-strategy">
            <input type="hidden" name="${actionPrefix}-${actionIndex}-DELETE" id="id_${actionPrefix}-${actionIndex}-DELETE">
            <div class="component-header">
                <h5 class="mb-0 action-title">动作 ${actionsContainer.querySelectorAll('.action-card:not([style*="display: none"])').length + 1}</h5>
                <button type="button" class="btn btn-outline-danger delete-action">
                    <i class="fas fa-trash"></i> 删除动作
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(1)')?.innerHTML || ''} <div class="form-text text-muted">选择要执行的动作类型</div></div> <!-- action_type -->
                <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(2)')?.innerHTML || ''} <div class="form-text text-muted">多个动作的执行顺序，数字越小越先执行</div></div> <!-- execution_order -->
            </div>

            <!-- 执行器字段 -->
            <div class="field-group action-fields action-actuator-fields" data-action-type="control_actuator">
                <h6 class="mb-3">执行器控制参数</h6>
                <div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(3)')?.innerHTML || ''} <div class="form-text text-muted">选择要控制的执行器</div></div></div> <!-- target_actuator -->
                <div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(4)')?.innerHTML || ''} <div class="form-text text-muted">JSON格式的命令内容，可以使用模板变量如 {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}sensor.name{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}project.name{% templatetag closevariable %}, {% templatetag openvariable %}now{% templatetag closevariable %}</div></div></div> <!-- command_payload_template -->
            </div>

            <!-- 通知字段 -->
            <div class="field-group action-fields action-notification-fields hidden-field-group" data-action-type="send_notification">
                <h6 class="mb-3">通知参数</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(5)')?.innerHTML || ''} <div class="form-text text-muted">选择通知的接收者类型</div></div> <!-- notification_recipient_type -->
                    <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(6)')?.innerHTML || ''} <div class="form-text text-muted">接收者的值，如邮箱地址、电话号码等</div></div> <!-- notification_recipient_value -->
                </div>
                <div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(7)')?.innerHTML || ''} <div class="form-text text-muted">通知内容，可以使用模板变量如 {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}device.status{% templatetag closevariable %}, {% templatetag openvariable %}condition_text{% templatetag closevariable %}, {% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}</div></div></div> <!-- notification_message_template -->
            </div>

            <!-- Webhook 字段 -->
            <div class="field-group action-fields action-webhook-fields hidden-field-group" data-action-type="call_webhook">
                <h6 class="mb-3">Webhook参数</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(9)')?.innerHTML || ''} <div class="form-text text-muted">要调用的Webhook URL</div></div> <!-- webhook_url. 注意: li 索引可能需要根据您的表单进行调整 -->
                    <div class="col-md-6 mb-3">${tempDiv.querySelector('li:nth-child(8)')?.innerHTML || ''} <div class="form-text text-muted">HTTP请求方法</div></div> <!-- webhook_method -->
                </div>
                <div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(10)')?.innerHTML || ''} <div class="form-text text-muted">JSON格式的HTTP请求头，可以使用模板变量如 {% templatetag openvariable %}strategy.id{% templatetag closevariable %}, {% templatetag openvariable %}project.id{% templatetag closevariable %}, {% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}。例如: {"Authorization": "Bearer secret_token", "X-Strategy-ID": "{% templatetag openvariable %}strategy.id{% templatetag closevariable %}"}</div></div></div> <!-- webhook_headers_template -->
                <div class="row"><div class="col-md-12 mb-3">${tempDiv.querySelector('li:nth-child(11)')?.innerHTML || ''} <div class="form-text text-muted">JSON格式的HTTP请求体，可以使用模板变量如 {% templatetag openvariable %}strategy.name{% templatetag closevariable %}, {% templatetag openvariable %}sensor.value{% templatetag closevariable %}, {% templatetag openvariable %}device.name{% templatetag closevariable %}, {% templatetag openvariable %}condition_text{% templatetag closevariable %}。例如: {"event": "strategy_triggered", "strategy_name": "{% templatetag openvariable %}strategy.name{% templatetag closevariable %}", "triggered_value": "{% templatetag openvariable %}sensor.value{% templatetag closevariable %}", "timestamp": "{% templatetag openvariable %}now|date:"Y-m-d H:i:s"{% templatetag closevariable %}"}</div></div></div> <!-- webhook_payload_template -->
            </div>
        `;
        styleTextareas(newActionElement);
        actionsContainer.appendChild(newActionElement);
        updateManagementForm(actionPrefix, true);
        bindEventListenersToAction(newActionElement);
        toggleActionFields(newActionElement); // 初始化
        reindexActions();
    }


    // --- 删除元素和重新索引 ---
    function deleteElement(element, prefix) {
        element.style.display = 'none';
        const deleteInput = element.querySelector(`input[name$="-DELETE"]`);
        if (deleteInput) {
            deleteInput.checked = true;
        } else {
            // 如果是尚未保存的新添加表单，它可能没有数据库ID，
            // 因此Django可能不会从empty_form创建DELETE字段。
            // 如果需要，我们可以添加一个，或者直接完全删除该元素。
            // 为简单起见，如果它确实是新的并且没有ID，则完全删除它就可以了。
            // 但对于Django formsets，标记为删除更安全。
            const idInput = element.querySelector(`input[name$="-id"]`);
            if (!idInput || !idInput.value) { // 没有数据库ID，是全新的
                element.remove(); // 如果是新的未保存项，则完全删除
                // 如果已删除，我们可能需要递减TOTAL_FORMS，
                // 但Django formsets期望TOTAL_FORMS是最高索引+1
                // updateManagementForm(prefix, false); // 这可能会有问题
                return true; // 表示它已完全删除
            }
            // 如果它有ID输入但没有DELETE输入，则说明模板有问题。
            // 目前，我们假设DELETE输入始终存在或已添加。
            // 为了一致性，我们确保如果新项缺少DELETE输入，则添加它
             if (!deleteInput && element.dataset.groupPrefix) { // 组的示例
                const delInput = document.createElement('input');
                delInput.type = 'hidden';
                delInput.name = `${element.dataset.groupPrefix}-DELETE`;
                delInput.id = `id_${element.dataset.groupPrefix}-DELETE`;
                delInput.checked = true;
                element.appendChild(delInput);
            } else if (!deleteInput && element.dataset.conditionPrefix) { // 条件的示例
                const delInput = document.createElement('input');
                delInput.type = 'hidden';
                delInput.name = `${element.dataset.conditionPrefix}-DELETE`;
                delInput.id = `id_${element.dataset.conditionPrefix}-DELETE`;
                delInput.checked = true;
                element.appendChild(delInput);
            } else if (!deleteInput && element.dataset.actionPrefix) { // 动作的示例
                const delInput = document.createElement('input');
                delInput.type = 'hidden';
                delInput.name = `${element.dataset.actionPrefix}-DELETE`;
                delInput.id = `id_${element.dataset.actionPrefix}-DELETE`;
                delInput.checked = true;
                element.appendChild(delInput);
            }
        }
        return false; // 表示它已标记为删除
    }

    function reindexConditionGroups() {
        const visibleGroups = conditionGroupsContainer.querySelectorAll('.condition-group:not([style*="display: none"])');
        visibleGroups.forEach((group, index) => {
            group.querySelector('.group-title').textContent = `条件组 ${index + 1}`;
            // 如果需要，更新执行顺序，但这最好由用户管理
            // const orderInput = group.querySelector('input[name$="-execution_order"]');
            // if (orderInput) orderInput.value = index;
        });
    }

    function reindexConditionsInGroup(groupElement) {
        const visibleConditions = groupElement.querySelectorAll('.condition:not([style*="display: none"])');
        visibleConditions.forEach((condition, index) => {
            condition.querySelector('.condition-title').textContent = `条件 ${index + 1}`;
        });
    }

    function reindexActions() {
        const visibleActions = actionsContainer.querySelectorAll('.action-card:not([style*="display: none"])');
        visibleActions.forEach((action, index) => {
            action.querySelector('.action-title').textContent = `动作 ${index + 1}`;
            // const orderInput = action.querySelector('input[name$="-execution_order"]');
            // if (orderInput) orderInput.value = index;
        });
    }

    // --- 事件绑定 ---
    function bindEventListenersToGroup(groupElement) {
        groupElement.querySelector('.delete-group').addEventListener('click', function () {
            deleteElement(groupElement, 'conditiongroup_set');
            reindexConditionGroups();
        });
        groupElement.querySelector('.add-condition').addEventListener('click', function () {
            addCondition(this);
        });
        // 组级别动态字段的事件侦听器 (如果有的话)
    }

    function bindEventListenersToCondition(conditionElement) {
        conditionElement.querySelector('.delete-condition').addEventListener('click', function () {
            const groupElement = conditionElement.closest('.condition-group');
            const removedFully = deleteElement(conditionElement, groupElement.dataset.groupPrefix + '-condition_set');
            if(removedFully) {
                 // 如果完全删除，我们需要调整嵌套 formset 的 TOTAL_FORMS
                const nestedPrefix = groupElement.dataset.groupPrefix + '-condition_set';
                const totalFormsInput = document.getElementById(`id_${nestedPrefix}-TOTAL_FORMS`);
                if (totalFormsInput) totalFormsInput.value = parseInt(totalFormsInput.value) -1;
            }
            reindexConditionsInGroup(groupElement);
        });
        conditionElement.querySelector('select[name$="-data_source_type"]').addEventListener('change', () => toggleConditionFields(conditionElement));
        conditionElement.querySelector('select[name$="-threshold_value_type"]').addEventListener('change', () => toggleConditionFields(conditionElement));
    }

    function bindEventListenersToAction(actionElement) {
        actionElement.querySelector('.delete-action').addEventListener('click', function () {
            deleteElement(actionElement, 'action_set');
            reindexActions();
        });
        actionElement.querySelector('select[name$="-action_type"]').addEventListener('change', () => toggleActionFields(actionElement));
    }

    // --- 初始化 ---
    function initializePage() {
        // 绑定到 Django 加载的现有元素
        conditionGroupsContainer.querySelectorAll('.condition-group').forEach(group => {
            styleTextareas(group);
            bindEventListenersToGroup(group);
            group.querySelectorAll('.condition').forEach(condition => {
                styleTextareas(condition);
                bindEventListenersToCondition(condition);
                toggleConditionFields(condition); // 初始切换
            });
            reindexConditionsInGroup(group); // 初始编号
        });
        reindexConditionGroups(); // 初始编号

        actionsContainer.querySelectorAll('.action-card').forEach(action => {
            styleTextareas(action);
            bindEventListenersToAction(action);
            toggleActionFields(action); // 初始切换
        });
        reindexActions(); // 初始编号

        // 如果后端没有组/动作存在，则各添加一个默认的
        if (conditionGroupsContainer.querySelectorAll('.condition-group').length === 0 && '{{ condition_group_formset.total_form_count }}' === '0') {
            addGroupButton.click(); // 这也会添加一个条件
        }
        if (actionsContainer.querySelectorAll('.action-card').length === 0 && '{{ action_formset.total_form_count }}' === '0') {
            addActionButton.click();
        }
    }

    // 添加按钮监听器
    addGroupButton.addEventListener('click', addConditionGroup);
    addActionButton.addEventListener('click', addAction);

    // 处理表单提交
    strategyConfigForm.addEventListener('submit', function (e) {
        e.preventDefault();
        
        // 表单提交前验证
        let isValid = true;
        let validationErrors = [];
        
        // 检查条件组是否为空
        const visibleGroups = conditionGroupsContainer.querySelectorAll('.condition-group:not([style*="display: none"])');
        visibleGroups.forEach((group, index) => {
            const visibleConditions = group.querySelectorAll('.condition:not([style*="display: none"])');
            if (visibleConditions.length === 0) {
                isValid = false;
                validationErrors.push(`条件组 ${index + 1} 没有添加任何条件`);
            }
        });
        
        // 如果没有条件组，也显示错误
        if (visibleGroups.length === 0) {
            isValid = false;
            validationErrors.push("请至少添加一个条件组");
        }
        
        // 如果验证失败，显示错误并终止提交
        if (!isValid) {
            showToast("表单验证失败：\n" + validationErrors.join("\n"), "error");
            return;
        }
        
        // 在表单提交前，确保每个条件的group字段关联到正确的条件组
        visibleGroups.forEach(groupElement => {
            const groupId = groupElement.querySelector('input[name$="-id"]').value || '';
            const groupPrefix = groupElement.getAttribute('data-group-prefix') || 
                              groupElement.id.replace('group-', 'conditiongroup_set-');
            
            const conditionsContainer = groupElement.querySelector('.conditions-container');
            const visibleConditions = conditionsContainer.querySelectorAll('.condition:not([style*="display: none"])');
            
            visibleConditions.forEach(condition => {
                const groupInput = condition.querySelector('input[name$="-group"]');
                if (groupInput) {
                    if (groupId) {
                        // 对已保存的条件组，直接使用其ID
                        groupInput.value = groupId;
            } else {
                        // 对于新创建的条件组，我们使用一个特殊标记
                        // 添加隐藏字段标记此条件属于哪个新组
                        const conditionElement = groupInput.closest('.condition');
                        const conditionPrefix = conditionElement.getAttribute('data-condition-prefix');
                        
                        if (conditionPrefix) {
                            // 设置临时引用字段，后端用这个来关联新创建的条件组和条件
                            if (!conditionElement.querySelector(`input[name="${conditionPrefix}-temp_group_ref"]`)) {
                                const tempGroupRefInput = document.createElement('input');
                                tempGroupRefInput.type = 'hidden';
                                tempGroupRefInput.name = `${conditionPrefix}-temp_group_ref`;
                                tempGroupRefInput.value = groupPrefix;
                                conditionElement.appendChild(tempGroupRefInput);
                                
                                console.log(`为条件 ${conditionPrefix} 添加临时引用到组 ${groupPrefix}`);
                            }
                        }
                        
                        // 暂时将group设为空，后端会根据temp_group_ref处理
                        groupInput.value = '';
                    }
                }
            });
        });
        
        // 记录表单数据，用于调试
        console.log("提交表单数据...");
        
        // 输出管理表单信息
        console.log("条件组管理表单:", {
            TOTAL_FORMS: document.getElementById('id_conditiongroup_set-TOTAL_FORMS').value,
            INITIAL_FORMS: document.getElementById('id_conditiongroup_set-INITIAL_FORMS').value
        });
        
        // 检查所有条件组的条件管理表单
        visibleGroups.forEach((group, index) => {
            const groupPrefix = group.getAttribute('data-group-prefix');
            if (groupPrefix) {
                const totalFormsId = `id_${groupPrefix}-condition_set-TOTAL_FORMS`;
                const initialFormsId = `id_${groupPrefix}-condition_set-INITIAL_FORMS`;
                console.log(`条件组 #${index+1} (${groupPrefix}) 条件管理表单:`, {
                    TOTAL_FORMS: document.getElementById(totalFormsId)?.value || '未找到',
                    INITIAL_FORMS: document.getElementById(initialFormsId)?.value || '未找到'
                });
            }
        });
        
        // 输出动作管理表单信息
        console.log("动作管理表单:", {
            TOTAL_FORMS: document.getElementById('id_action_set-TOTAL_FORMS').value,
            INITIAL_FORMS: document.getElementById('id_action_set-INITIAL_FORMS').value
        });
        
        // 条件组和条件的关系调试
        visibleGroups.forEach(groupElement => {
            const groupId = groupElement.querySelector('input[name$="-id"]').value || '';
            const groupPrefix = groupElement.getAttribute('data-group-prefix') || 
                             groupElement.id.replace('group-', 'conditiongroup_set-');
            
            console.log(`条件组 ${groupPrefix} - ID: ${groupId || '新组'}`);
            
            const conditionsContainer = groupElement.querySelector('.conditions-container');
            const visibleConditions = conditionsContainer.querySelectorAll('.condition:not([style*="display: none"])');
            
            visibleConditions.forEach(conditionElement => {
                const conditionPrefix = conditionElement.getAttribute('data-condition-prefix');
                const conditionId = conditionElement.querySelector('input[name$="-id"]').value || '';
                const groupValue = conditionElement.querySelector('input[name$="-group"]').value;
                const tempRef = conditionElement.querySelector('input[name$="-temp_group_ref"]')?.value || '';
                
                console.log(`  条件 ${conditionPrefix} - ID: ${conditionId || '新条件'}, 关联组: ${groupValue || '待关联'} ${tempRef ? '(临时引用: '+tempRef+')' : ''}`);
                
                // 记录条件的数据源类型和主要值
                const dataSourceType = conditionElement.querySelector('select[name$="-data_source_type"]').value;
                console.log(`    数据源类型: ${dataSourceType}`);
                
                if (dataSourceType === 'sensor') {
                    const sensorSelect = conditionElement.querySelector('select[name$="-sensor"]');
                    if (sensorSelect) {
                        console.log(`    传感器ID: ${sensorSelect.value}`);
                    }
                } else if (dataSourceType === 'device_attribute') {
                    const deviceAttrInput = conditionElement.querySelector('input[name$="-device_attribute"]');
                    if (deviceAttrInput) {
                        console.log(`    设备属性: ${deviceAttrInput.value}`);
                    }
                }
            });
        });
        
        const formData = new FormData(strategyConfigForm);
        let formDataDebug = {};
        
        // 使用FormData API转为对象，便于调试
        for (let [key, value] of formData.entries()) {
            formDataDebug[key] = value;
        }
        console.log("表单数据:", formDataDebug);
        
        toggleLoading(true);

        fetch(strategyConfigForm.action, {
                method: 'POST',
                body: formData,
                headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
            // 检查响应类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    return { isJson: true, data };
                }).catch(err => {
                    return { isJson: false, response };
                });
            } else {
                // 不是JSON响应，可能是HTML或其他类型
                return { isJson: false, response };
            }
        })
        .then(result => {
            toggleLoading(false);
            
            if (result.isJson) {
                // 处理JSON响应
                const data = result.data;
                if (data && data.status === 'success') { // 假设服务器返回 {status: 'success', message: '...'}
                    showToast(data.message || '配置已成功保存！', 'success');
                    setTimeout(() => window.location.reload(), 1500); // 显示 toast 后重新加载
                } else if (data && data.errors) {
                    // 处理服务器返回的表单错误
                    let errorMsg = '保存失败:\n';
                    for (const [key, errorList] of Object.entries(data.errors)) {
                        errorMsg += `${key}: ${errorList.join(', ')}\n`;
                    }
                    showToast(errorMsg, 'error');
                } else {
                    showToast(data.message || '操作完成，但未收到预期的响应格式。', 'info');
                    setTimeout(() => window.location.reload(), 1500);
                }
            } else {
                // 处理非JSON响应（如HTML）
                const response = result.response;
                if (response.ok) {
                    // 如果响应是成功的（如200或302）
                    showToast('配置已成功保存，正在刷新页面...', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    // 如果响应是错误的
                    showToast(`保存失败: ${response.status} ${response.statusText}`, 'error');
                }
            }
            })
            .catch(error => {
            toggleLoading(false);
            console.error('保存错误:', error);
            let errorMsg = '保存配置时出错。请尝试刷新页面后重新提交。';
            showToast(errorMsg, 'error');
            });
        });

    initializePage();
});
</script>

{% endblock %} 